stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/tablero-innovacion
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA
  DEPLOY_USER: gitlab
  UPLOADS_VOL: tablero_innovacion_uploads   # volumen persistente para /uploads

build:
  stage: build
  image: docker:24.0.5
  services: ["docker:24.0.5-dind"]
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker build -t "$DOCKER_IMAGE:$DOCKER_TAG" -t "$DOCKER_IMAGE:latest" .
    - docker push "$DOCKER_IMAGE:$DOCKER_TAG"
    - docker push "$DOCKER_IMAGE:latest"
  tags: [ dind ]
  only: [ main, infra ]

deploy:
  stage: deploy
  image: alpine:3.19
  before_script:
    - apk add --no-cache openssh
    - chmod 600 "$SSH_KEY_DOCKER_01"     # permisos correctos para la clave
  script:
    - |
      ssh -o StrictHostKeyChecking=no -i "$SSH_KEY_DOCKER_01" "$DEPLOY_USER@$IP_ADDRESS_DOCKER_01" "
        set -e

        echo 'Login al registry...'
        docker login -u \"$CI_REGISTRY_USER\" -p \"$CI_REGISTRY_PASSWORD\" \"$CI_REGISTRY\"

        echo 'Pull de la imagen...'
        docker pull \"$DOCKER_IMAGE:latest\"

        echo 'Asegurar volumen persistente...'
        docker volume create \"$UPLOADS_VOL\" >/dev/null 2>&1 || true

        # Migrar uploads del contenedor viejo al volumen (solo si exist√≠a)
        if docker ps -a --format '{{.Names}}' | grep -q '^tablero-innovacion$'; then
          echo 'Migrando /var/www/html/uploads del contenedor antiguo al volumen...'
          docker run --rm --volumes-from tablero-innovacion -v \"$UPLOADS_VOL\":/dest alpine:3.19 \
            sh -c 'mkdir -p /dest && cp -a /var/www/html/uploads/. /dest/ || true'
          docker stop tablero-innovacion || true
          docker rm   tablero-innovacion || true
        fi

        echo 'Lanzando nuevo contenedor...'
        docker run -d --name tablero-innovacion \
          -p 8089:80 \
          --env-file /opt/tablero-innovacion/.env \
          -v \"$UPLOADS_VOL\":/var/www/html/uploads \
          \"$DOCKER_IMAGE:latest\"

        echo 'Permisos y estructura en /uploads...'
        docker exec tablero-innovacion sh -lc '
          set -e
          mkdir -p /var/www/html/uploads
          chown -R www-data:www-data /var/www/html/uploads
          for d in documentacion intervenciones judiciales objetos procedimientos proyectos registros reuniones sgc2025; do
            mkdir -p /var/www/html/uploads/$d
          done
          if [ ! -f /var/www/html/uploads/.htaccess ]; then
            printf \"%s\n\" \
\"Options -Indexes\" \
\"<FilesMatch \\\\.(php|phar|phtml|cgi|pl|py|cgi)$>\" \
\"  Require all denied\" \
\"</FilesMatch>\" \
\"<IfModule mod_headers.c>\" \
\"  Header set Content-Type-Options \\\"nosniff\\\"\" \
\"</IfModule>\" \
> /var/www/html/uploads/.htaccess
            chown www-data:www-data /var/www/html/uploads/.htaccess
          fi
        '
      "
  tags: [ dind ]
  only: [ main, infra ]



